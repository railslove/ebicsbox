#!/usr/bin/env ruby
require 'dotenv'
Dotenv.load

# Load environment
require 'bundler'
Bundler.setup(:default, :development)

require 'securerandom'
require 'sequel'

# How often to retry the migration
tries = 3

begin
  # Load app configuration
  require_relative '../lib/epics/box/configuration'
  configuration = Epics::Box::Configuration.new

  # Setup database connection
  DB ||= Sequel.connect(configuration.database_url, max_connections: 10)
  Sequel.extension :migration, :core_extensions

  # Migrate to latest version
  version = Sequel::Migrator.run(DB, File.join( File.dirname(__FILE__),  '../migrations/'), use_transactions: true)
  puts "migrated to: #{version}"
rescue Exception => e
  puts e.message
  tries -= 1
  if tries > 0
    puts
    sleep 2
    retry
  else
    puts "Oh Noes! Waited too long"
    exit(1)
  end
end
