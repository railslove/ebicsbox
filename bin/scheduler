#!/usr/bin/env ruby

env = ENV.fetch('RACK_ENV', :development)
if %w[development test].include?(env.to_s)
  # Load environment from file
  require 'dotenv'
  Dotenv.load
end

require_relative '../config/bootstrap'
require_relative '../box/queue'

def run_every(minutes)
  minutes_since_start = Time.now.to_i / 60
  yield if (minutes_since_start % minutes) < 10 # heroku jobs run every 10 minutes
end

UPDATE_BANK_STATEMENTS_INTERVAL = ENV['UPDATE_BANK_STATEMENTS_INTERVAL'] || 60
UPDATE_PROCESSING_STATUS_INTERVAL = ENV['UPDATE_PROCESSING_STATUS_INTERVAL'] || 300

run_every(UPDATE_BANK_STATEMENTS_INTERVAL) do
  Box::Queue.fetch_account_statements
end

run_every(UPDATE_PROCESSING_STATUS_INTERVAL) do
  Box::Queue.fetch_account_statements
end
